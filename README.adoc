// SPDX-License-Identifier: PMPL-1.0
= WP-Resurrect: Site Operations Control Plane (SOCP)

image:https://img.shields.io/badge/license-Palimpsest--MPL--1.0-purple.svg[Palimpsest-MPL-1.0,link="https://github.com/hyperpolymath/palimpsest-license"] image:https://img.shields.io/badge/philosophy-Palimpsest-purple.svg[Palimpsest,link="https://github.com/hyperpolymath/palimpsest-licence"]
:toc:
:sectnums:
:icons: font

image:https://img.shields.io/badge/RSR-Infrastructure-cd7f32[RSR Infrastructure]
image:https://img.shields.io/badge/Phase-Development-yellow[Phase]
image:https://img.shields.io/badge/License-AGPL--3.0-blue[License]
image:https://img.shields.io/badge/Guix-Primary-purple?logo=gnu[Guix]

== Overview

**WP-Resurrect** is a centralized **Site Operations Control Plane** (SOCP) for managing multiple web properties through a single, security-hardened command center.

=== The Problem

Managing multiple WordPress sites (or any web properties) involves repetitive configuration of:

* Hidden primary DNS setup with DNSSEC
* Security headers (CSP, HSTS, X-Frame-Options, etc.)
* PHP settings, pool configuration, OPcache tuning
* Web server configs (nginx/Apache/LiteSpeed)
* OWASP ModSecurity rules
* Fail2ban/CrowdSec rules
* WordPress hardening (wp-config.php, XML-RPC blocking)
* Database tuning and backup scheduling
* Redis/Memcached object caching
* SSL certificate management
* Google API integrations (Maps, reCAPTCHA)
* Rate limiting and bot protection
* ...and doing it consistently across all sites

=== The Solution

SOCP provides:

* **Configuration as Code**: All site settings in type-checked Nickel configs
* **Centralized Management**: Push changes to all sites, groups, or individuals
* **Hidden Control Plane**: Behind SDP (OpenZiti), IPv6-only access
* **ncurses Dashboard**: Real-time status across all sites
* **Idempotent Deployments**: SaltStack ensures consistent state
* **Secret Management**: Encrypted pillars, rotation scheduling
* **Audit Trail**: Every change tracked in Guile state files

== Architecture

[source]
----
┌─────────────────────────────────────────────────────────────────┐
│  OPERATOR ──────────────────────────────────────────────────────│
│  │                                                              │
│  │ socp-tui (Rust/ratatui ncurses dashboard)                   │
│  │ • Site status     • Config diffs     • Deployments          │
│  ▼                                                              │
├─────────────────────────────────────────────────────────────────┤
│  ORCHESTRATION ─────────────────────────────────────────────────│
│  │                                                              │
│  │ socp-api (Gleam) + Config Compiler (Nickel → Salt)          │
│  │ • REST/gRPC API   • Validation      • State (Guile)         │
│  ▼                                                              │
├─────────────────────────────────────────────────────────────────┤
│  INFRASTRUCTURE ────────────────────────────────────────────────│
│  │                                                              │
│  │ SaltStack Master                                             │
│  │ • salt-master: Central command    • salt-api: REST          │
│  │ • Encrypted pillars (secrets)     • Idempotent states       │
│  ▼                                                              │
├─────────────────────────────────────────────────────────────────┤
│  SECURITY PERIMETER ────────────────────────────────────────────│
│  │                                                              │
│  │ OpenZiti SDP  +  IPv6-only  +  mTLS                         │
│  │ • Zero trust     • No IPv4        • Client certs            │
│  ▼                                                              │
├─────────────────────────────────────────────────────────────────┤
│  MANAGED SITES ─────────────────────────────────────────────────│
│                                                                 │
│  [Site A]    [Site B]    [Site C]    [Site D]    [Site N]      │
│   WP+PHP      WP+PHP      Static      Custom       ...         │
│   nginx       Apache      nginx       LiteSpeed                 │
└─────────────────────────────────────────────────────────────────┘
----

== Quick Start

[source,bash]
----
# Enter development environment
guix shell -D -f guix.scm

# Build the TUI
cd src/socp-tui && cargo build --release

# Run the dashboard
./target/release/socp-tui --api-url https://[::1]:8443

# Or use justfile
just build
just tui
----

== Directory Structure

[source]
----
wp-resurrect/
├── config/                    # Nickel configurations
│   ├── schema/                # Type definitions
│   │   ├── site.ncl           # Main site schema
│   │   ├── webserver.ncl      # nginx/Apache/LiteSpeed
│   │   ├── php.ncl            # PHP-FPM settings
│   │   ├── wordpress.ncl      # WordPress config
│   │   ├── database.ncl       # MariaDB/MySQL
│   │   ├── cache.ncl          # Redis/Varnish
│   │   ├── security.ncl       # WAF, headers, fail2ban
│   │   └── dns.ncl            # DNS records, DNSSEC
│   ├── sites/                 # Per-site configs
│   ├── groups/                # Site groups
│   └── includes/              # Shared snippets
│
├── salt/                      # SaltStack (Python, per RSR)
│   ├── states/socp/           # State files
│   │   ├── dns/               # PowerDNS management
│   │   ├── webserver/         # nginx/Apache/LS states
│   │   ├── php/               # PHP-FPM states
│   │   ├── wordpress/         # WP hardening
│   │   ├── database/          # MariaDB states
│   │   ├── cache/             # Redis/Varnish states
│   │   └── security/          # ModSec/fail2ban
│   └── pillar/                # Encrypted secrets
│
├── src/
│   ├── socp-tui/              # Rust TUI (ratatui)
│   ├── socp-api/              # Gleam API service
│   └── socp-compile/          # Config compiler
│
├── state/                     # Guile state management
│   ├── STATE.scm              # Current state checkpoint
│   ├── ECOSYSTEM.scm          # Site relationships
│   └── lib/                   # State utilities
│
├── sdp/                       # Software-Defined Perimeter
│   ├── ziti/                  # OpenZiti configs
│   └── ipv6-firewall.nft      # nftables rules
│
├── docs/
│   └── ARCHITECTURE.adoc      # Detailed design
│
└── guix.scm                   # Package definition
----

== Language Stack

Per link:.claude/CLAUDE.md[RSR Language Policy]:

[cols="1,2,2"]
|===
|Component |Language |Rationale

|TUI Dashboard
|Rust (ratatui)
|Performance, safety, no Python

|API Service
|Gleam
|BEAM fault tolerance, compiles to JS

|Configuration
|Nickel
|Type-safe config language

|State Files
|Guile Scheme
|RSR standard for state

|Infrastructure
|SaltStack (Python)
|Python allowed for Salt only

|Package Manager
|Guix
|Primary, with Nix fallback
|===

== Configuration Example

[source,nickel]
----
# config/sites/mysite.ncl
{
  id = "mysite-prod",
  domain = "mysite.com",
  environment = 'production,

  webserver = {
    type = 'nginx,
    ssl = { provider = 'letsencrypt, hsts = true },
  },

  php = {
    version = "8.3",
    opcache = { enable = true, jit = true },
  },

  wordpress = {
    auto_update_core = 'minor,
    security = { disallow_file_edit = true, block_xmlrpc = true },
  },

  security = {
    waf = 'modsecurity,
    owasp_crs = { enabled = true, paranoia_level = 1 },
    rate_limit = { requests_per_second = 50 },
  },

  dns = {
    hidden_primary = { enabled = true },
    dnssec = { enabled = true },
  },
}
----

== Deployment Flow

[source]
----
1. Edit Nickel config
       │
       ▼
2. just validate-config  (Type check)
       │
       ▼
3. just diff-config      (Preview changes)
       │
       ▼
4. just apply-config     (Deploy via Salt)
       │
       ▼
5. STATE.scm updated     (Audit trail)
       │
       ▼
6. socp-tui shows status (Real-time)
----

== Security Model

* **Zero Trust**: OpenZiti SDP, no direct network access
* **IPv6-Only**: Control plane binds only to IPv6
* **mTLS**: Client certificates required
* **Encrypted Secrets**: Salt pillars with GPG
* **Audit Trail**: All changes in STATE.scm
* **OWASP CRS**: ModSecurity on all sites
* **Fail2ban/CrowdSec**: Brute force protection

== License

SPDX-License-Identifier: `PMPL-1.0-or-later`

== Links

* link:docs/ARCHITECTURE.adoc[Architecture Documentation]
* link:SECURITY.md[Security Policy]
* link:CONTRIBUTING.md[Contributing Guide]
